<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recetas Sencillas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Onest:wght@100..900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  
  <!-- Estilos para el modal y funcionalidades -->
  <style>
    /* ==============================================
       ESTILOS PARA COMPONENTES MEJORADOS
       ============================================== */
    
    /* Header mejorado */
    .enlace-usuario {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: inherit;
      margin-right: 15px;
    }
    
    .avatarUsuarioSesion {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    /* B√∫squeda mejorada */
    .busqueda-container {
      margin-bottom: 30px;
    }
    
    .formulario-busqueda {
      display: flex;
      gap: 10px;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .input-busqueda {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 25px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s ease;
    }
    
    .input-busqueda:focus {
      border-color: #007bff;
    }
    
    .btn-busqueda {
      padding: 12px 24px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }
    
    .btn-busqueda:hover {
      background-color: #0056b3;
    }
    
    /* Filtros mejorados */
    .filtros {
      display: flex;
      gap: 10px;
      margin-bottom: 40px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .filtro-btn {
      padding: 8px 16px;
      background: white;
      color: #333;
      border: 2px solid #e1e5e9;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      font-size: 14px;
    }
    
    .filtro-btn:hover,
    .filtro-btn.activo {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }
    
    /* Tarjetas de recetas mejoradas */
    .tarjeta-receta {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }
    
    .tarjeta-receta:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .titulo-receta {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    
    .descripcion-receta {
      color: #666;
      line-height: 1.5;
      margin-bottom: 12px;
    }
    
    .info-receta {
      margin: 10px 0;
      font-size: 14px;
      color: #666;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
    }
    
    .categorias-receta {
      margin: 10px 0;
    }
    
    .categoria-tag {
      display: inline-block;
      background: #e9ecef;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-right: 5px;
      color: #495057;
    }
    
    .footer-tarjeta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
    }
    
    .acciones-receta {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .me-gustas {
      font-size: 14px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .btn-corazon {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      transition: all 0.2s ease;
      color: #666;
    }
    
    .btn-corazon:hover {
      transform: scale(1.2);
      color: #e74c3c;
    }
    
    .btn-corazon.liked {
      color: #e74c3c;
    }
    
    /* Sin recetas */
    .no-recetas {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: #666;
      background: #f8f9fa;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .btn-crear-receta {
      display: inline-block;
      margin-top: 20px;
      padding: 12px 24px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    
    .btn-crear-receta:hover {
      background-color: #0056b3;
    }
    
    .enlace-registro {
      color: #007bff;
      text-decoration: none;
    }
    
    .enlace-registro:hover {
      text-decoration: underline;
    }
    
    /* Paginaci√≥n */
    .paginacion {
      margin-top: 40px;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
    }
    
    .btn-paginacion {
      display: inline-block;
      padding: 10px 15px;
      text-decoration: none;
      color: #007bff;
      border: 2px solid #007bff;
      border-radius: 5px;
      transition: all 0.3s ease;
    }
    
    .btn-paginacion:hover {
      background-color: #007bff;
      color: white;
    }
    
    .pagina-actual {
      font-weight: 500;
      color: #333;
    }
    
    /* ==============================================
       ESTILOS PARA EL MODAL DE DETALLE
       ============================================== */
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: modalAppear 0.3s ease-out;
    }
    
    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-50px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-header h2 {
      margin: 0;
      color: #333;
      font-size: 24px;
      flex: 1;
      margin-right: 20px;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 32px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .modal-close:hover {
      background-color: #f5f5f5;
      color: #333;
    }
    
    .modal-body {
      padding: 0;
    }
    
    .modal-imagen-container {
      width: 100%;
      height: 300px;
      overflow: hidden;
    }
    
    .modal-imagen {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .modal-info {
      padding: 20px;
    }
    
    .modal-autor {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .autor-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .autor-info {
      flex-grow: 1;
    }
    
    .autor-nombre {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 2px;
    }
    
    .receta-fecha {
      font-size: 14px;
      color: #666;
    }
    
    .btn-like-modal {
      background: none;
      border: 2px solid #e74c3c;
      border-radius: 25px;
      padding: 8px 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      color: #e74c3c;
    }
    
    .btn-like-modal:hover,
    .btn-like-modal.liked {
      background-color: #e74c3c;
      color: white;
    }
    
    .modal-seccion {
      margin-bottom: 20px;
    }
    
    .modal-seccion h4 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .modal-seccion p {
      color: #666;
      line-height: 1.6;
      margin: 0;
    }
    
    .categorias-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .categoria-modal-tag {
      background: #007bff;
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 14px;
    }
    
    .ingredientes-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .ingredientes-list li {
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
    }
    
    .ingredientes-list li:last-child {
      border-bottom: none;
    }
    
    .instrucciones-list {
      padding-left: 20px;
    }
    
    .instrucciones-list li {
      margin-bottom: 12px;
      line-height: 1.6;
      color: #555;
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    
    .btn-primary, .btn-secondary {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background-color: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #0056b3;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #545b62;
    }
    
    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ==============================================
       RESPONSIVE DESIGN
       ============================================== */
    
    @media (max-width: 768px) {
      .enlace-usuario span {
        display: none;
      }
      
      .formulario-busqueda {
        flex-direction: column;
      }
      
      .filtros {
        justify-content: flex-start;
        overflow-x: auto;
        padding-bottom: 10px;
      }
      
      .modal-content {
        margin: 10px;
        max-height: 95vh;
      }
      
      .modal-header h2 {
        font-size: 20px;
      }
      
      .modal-imagen-container {
        height: 200px;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .btn-primary, .btn-secondary {
        width: 100%;
      }
      
      .paginacion {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>

<body>
  <!-- ==============================================
       HEADER
       ============================================== -->
  <header class="encabezado">
    <div class="contenedor">
      <h1 class="logo">
        <a href="{{ url_for('main.index') }}" style="text-decoration: none; color: inherit;">
          Recetas Sencillas
        </a>
      </h1>
      
      
      
      <div class="botones-header">
        {% if current_user and current_user.is_authenticated %}
          <a href="{{ url_for('api.ver_perfil', usuario_id=current_user.id) }}" class="enlace-usuario">
            <img src="{{ url_for('static', filename=current_user.foto_perfil) if current_user.foto_perfil != 'default.jpg' else 'https://via.placeholder.com/32x32?text=' + current_user.nombre[0] }}" 
                 alt="Foto de perfil" 
                 class="avatarUsuarioSesion">
            <span>{{ current_user.nombre }}</span>
          </a>
          <a href="{{ url_for('api.logout') }}">
            <button class="btn-transparente">Cerrar Sesi√≥n</button>
          </a>
        {% else %}
          <a href="{{ url_for('api.login') }}">
            <button class="btn-transparente">Iniciar Sesi√≥n</button>
          </a>
          <a href="{{ url_for('api.register') }}">
            <button class="btn-blanco">Registrarse</button>
          </a>
        {% endif %}
      </div>
    </div>
  </header>

  <!-- ==============================================
       CONTENIDO PRINCIPAL
       ============================================== -->
  <main class="contenedor principal">
    <h2 class="titulo-seccion">Descubre nuestras recetas</h2>
    
    <!-- Formulario de b√∫squeda -->
    <div class="busqueda-container">
      <form method="GET" action="{{ url_for('api.listar_recetas') }}" class="formulario-busqueda">
        <input type="text" 
               name="q" 
               placeholder="Buscar recetas..." 
               value="{{ request.args.get('q', '') }}" 
               class="input-busqueda">
        <button type="submit" class="btn-busqueda">Buscar</button>
      </form>
    </div>
    
    <!-- Filtros por categor√≠a -->
    <div class="filtros">
      <button class="filtro-btn {{ 'activo' if not request.args.get('categoria') else '' }}" 
              onclick="window.location.href='{{ url_for('main.index') }}'">
        Todas
      </button>
      
      {% if categorias %}
        {% for categoria in categorias %}
          <button class="filtro-btn {{ 'activo' if request.args.get('categoria')|int == categoria.id else '' }}"
                  onclick="window.location.href='{{ url_for('api.listar_recetas', categoria=categoria.id) }}'">
            {{ categoria.nombre }}
          </button>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Grid de recetas -->
    <section class="grid-recetas">
      {% if recetas_recientes %}
        {% for receta in recetas_recientes %}
          <article class="tarjeta-receta" onclick="abrirModalReceta({{ receta.id }})">
            <div class="imagen" 
                 style="background-image: url({{ url_for('static', filename=receta.imagen_portada) if receta.imagen_portada else 'https://via.placeholder.com/300x200?text=Sin+Imagen' }});">
            </div>
            
            <div class="contenido">
              <h3 class="titulo-receta">{{ receta.titulo }}</h3>
              <p class="descripcion-receta">
                {{ receta.descripcion[:100] }}{% if receta.descripcion|length > 100 %}...{% endif %}
              </p>
              
              <!-- Informaci√≥n adicional -->
              <div class="info-receta">
                {% if receta.tiempor_pre %}
                  <span>‚è±Ô∏è {{ receta.tiempor_pre }}</span>
                {% endif %}
                
                {% if receta.autor %}
                  <span style="margin-left: 10px;">üë®‚Äçüç≥ {{ receta.autor.nombre }}</span>
                {% endif %}
              </div>
              
              <!-- Categor√≠as -->
              {% if receta.categorias %}
                <div class="categorias-receta">
                  {% for categoria in receta.categorias[:2] %}
                    <span class="categoria-tag">{{ categoria.nombre }}</span>
                  {% endfor %}
                </div>
              {% endif %}
              
              <!-- Footer de la tarjeta -->
              <div class="footer-tarjeta">
                <span>{{ receta.fecha_creacion.strftime('%d/%m/%Y') }}</span>
                <div class="acciones-receta">
                  <span class="me-gustas" id="me-gustas-{{ receta.id }}">
                    ‚ù§Ô∏è <span class="contador-likes">{{ receta.contar_me_gustas() if receta.contar_me_gustas else 0 }}</span>
                  </span>
                  
                  {% if current_user.is_authenticated %}
                    <button class="btn-corazon" 
                            id="btn-like-{{ receta.id }}"
                            onclick="event.stopPropagation(); toggleMeGusta({{ receta.id }})"
                            data-liked="false">
                      ‚ô°
                    </button>
                  {% else %}
                    <span class="corazon">‚ô°</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </article>
        {% endfor %}
      {% else %}
        <!-- Mensaje cuando no hay recetas -->
        <div class="no-recetas">
          <h3>No hay recetas disponibles</h3>
          <p>¬°S√© el primero en compartir una deliciosa receta!</p>
          
          {% if current_user.is_authenticated %}
            <a href="{{ url_for('api.nueva_receta') }}" class="btn-crear-receta">
              Crear Primera Receta
            </a>
          {% else %}
            <p class="texto-registro">
              <a href="{{ url_for('api.register') }}" class="enlace-registro">Reg√≠strate</a> 
              para crear tu primera receta
            </p>
          {% endif %}
        </div>
      {% endif %}
    </section>
    
    <!-- Paginaci√≥n -->
    {% if pagination %}
      <div class="paginacion">
        {% if pagination.has_prev %}
          <a href="{{ url_for('api.listar_recetas', pagina=pagination.prev_num) }}" class="btn-paginacion">
            ‚Üê Anterior
          </a>
        {% endif %}
        
        <span class="pagina-actual">P√°gina {{ pagination.page }} de {{ pagination.pages }}</span>
        
        {% if pagination.has_next %}
          <a href="{{ url_for('api.listar_recetas', pagina=pagination.next_num) }}" class="btn-paginacion">
            Siguiente ‚Üí
          </a>
        {% endif %}
      </div>
    {% endif %}
  </main>

  <!-- ==============================================
       MODAL DE DETALLE DE RECETA
       ============================================== -->
  <div id="modalDetalleReceta" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <!-- Header del modal -->
      <div class="modal-header">
        <h2 id="modalTitulo">Cargando...</h2>
        <button class="modal-close" onclick="cerrarModalReceta()" aria-label="Cerrar modal">&times;</button>
      </div>
      
      <!-- Cuerpo del modal -->
      <div class="modal-body">
        <div class="modal-imagen-container">
          <img id="modalImagen" src="" alt="Imagen de la receta" class="modal-imagen">
        </div>
        
        <div class="modal-info">
          <!-- Informaci√≥n del autor -->
          <div class="modal-autor">
            <img id="modalAutorImagen" src="" alt="Foto del autor" class="autor-avatar">
            <div class="autor-info">
              <span class="autor-nombre" id="modalAutorNombre">Autor</span>
              <span class="receta-fecha" id="modalFecha">Fecha</span>
            </div>
            {% if current_user.is_authenticated %}
              <button class="btn-like-modal" id="btnLikeModal" onclick="toggleMeGustaModal()">
                <span id="iconoLikeModal">‚ô°</span>
                <span id="contadorLikeModal">0</span>
              </button>
            {% endif %}
          </div>
          
          <!-- Descripci√≥n -->
          <div class="modal-seccion modal-descripcion">
            <h4>üìÑ Descripci√≥n</h4>
            <p id="modalDescripcion">Cargando descripci√≥n...</p>
          </div>
          
          <!-- Tiempo de preparaci√≥n -->
          <div class="modal-seccion modal-tiempo" id="modalTiempoContainer" style="display: none;">
            <h4>‚è±Ô∏è Tiempo de preparaci√≥n</h4>
            <p id="modalTiempo">30 minutos</p>
          </div>
          
          <!-- Categor√≠as -->
          <div class="modal-seccion modal-categorias" id="modalCategoriasContainer" style="display: none;">
            <h4>üè∑Ô∏è Categor√≠as</h4>
            <div id="modalCategorias" class="categorias-list"></div>
          </div>
          
          <!-- Ingredientes -->
          <div class="modal-seccion modal-ingredientes" id="modalIngredientesContainer" style="display: none;">
            <h4>ü•ò Ingredientes</h4>
            <ul id="modalIngredientes" class="ingredientes-list"></ul>
          </div>
          
          <!-- Instrucciones -->
          <div class="modal-seccion modal-instrucciones" id="modalInstruccionesContainer" style="display: none;">
            <h4>üìù Instrucciones</h4>
            <ol id="modalInstrucciones" class="instrucciones-list"></ol>
          </div>
        </div>
      </div>
      
      <!-- Footer del modal -->
      <div class="modal-footer">
        <button class="btn-secondary" onclick="cerrarModalReceta()">Cerrar</button>
        {% if current_user.is_authenticated %}
          <button class="btn-primary" onclick="verRecetaCompleta()">Ver Receta Completa</button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ==============================================
       FOOTER
       ============================================== -->
  <footer class="pie">
    <p>¬© 2025 Recetas Sencillas ‚Äì Todos los derechos reservados</p>
    <p>Contacto: contacto@recetas-sencillas.com</p>
  </footer>

  <!-- ==============================================
       JAVASCRIPT
       ============================================== -->
<script>
  /* ==============================================
     VARIABLES GLOBALES
     ============================================== */
  let recetaActualId = null;
  
  /* ==============================================
     FUNCIONES DEL MODAL
     ============================================== */
  
  // Abrir modal con detalles de receta
  async function abrirModalReceta(recetaId) {
    recetaActualId = recetaId;
    const modal = document.getElementById('modalDetalleReceta');
    
    // Mostrar modal
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Estado de carga
    document.getElementById('modalTitulo').textContent = 'Cargando...';
    document.getElementById('modalDescripcion').textContent = 'Cargando informaci√≥n de la receta...';
    resetearSeccionesModal();
    
    try {
      const response = await fetch(`/api/recetas/${recetaId}`, {
        headers: { 'Accept': 'application/json' }
      });
      
      if (!response.ok) throw new Error('Error al cargar la receta');
      
      const data = await response.json();
      const receta = data.receta;
      
      // Llenar informaci√≥n del modal
      llenarInformacionBasica(receta);
      llenarTiempoPreparacion(receta.tiempo_preparacion);
      llenarCategorias(receta.categorias);
      llenarIngredientes(receta.ingredientes);
      llenarInstrucciones(receta.instrucciones);
      configurarMeGusta(receta);
      
    } catch (error) {
      console.error('Error:', error);
      mostrarErrorModal();
    }
  }
  
  // Llenar informaci√≥n b√°sica del modal
  function llenarInformacionBasica(receta) {
    document.getElementById('modalTitulo').textContent = receta.titulo;
    document.getElementById('modalImagen').src = receta.imagen_portada || 'https://via.placeholder.com/800x300?text=Sin+Imagen';
    document.getElementById('modalAutorNombre').textContent = receta.autor_nombre || 'Autor desconocido';
    document.getElementById('modalFecha').textContent = new Date(receta.fecha_creacion).toLocaleDateString('es-ES');
    document.getElementById('modalDescripcion').textContent = receta.descripcion || 'Sin descripci√≥n disponible';
    document.getElementById('modalAutorImagen').src = `https://via.placeholder.com/50x50?text=${receta.autor_nombre ? receta.autor_nombre.charAt(0) : 'U'}`;
  }
  
  // Llenar tiempo de preparaci√≥n
  function llenarTiempoPreparacion(tiempo) {
    const container = document.getElementById('modalTiempoContainer');
    if (tiempo) {
      document.getElementById('modalTiempo').textContent = tiempo;
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
    }
  }
  
  // Llenar categor√≠as
  function llenarCategorias(categorias) {
    const container = document.getElementById('modalCategoriasContainer');
    const lista = document.getElementById('modalCategorias');
    
    if (categorias && categorias.length > 0) {
      lista.innerHTML = '';
      categorias.forEach(categoria => {
        const span = document.createElement('span');
        span.className = 'categoria-modal-tag';
        span.textContent = categoria.nombre;
        lista.appendChild(span);
      });
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
    }
  }
  
  // Llenar ingredientes
  function llenarIngredientes(ingredientes) {
    const container = document.getElementById('modalIngredientesContainer');
    const lista = document.getElementById('modalIngredientes');
    
    if (ingredientes && ingredientes.length > 0) {
      lista.innerHTML = '';
      ingredientes.forEach(ingrediente => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${ingrediente.nombre}</span>
          <span>${ingrediente.cantidad} ${ingrediente.unidad_medida}</span>
        `;
        lista.appendChild(li);
      });
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
    }
  }
  
  // Llenar instrucciones
  function llenarInstrucciones(instrucciones) {
    const container = document.getElementById('modalInstruccionesContainer');
    const lista = document.getElementById('modalInstrucciones');
    
    if (instrucciones && instrucciones.length > 0) {
      lista.innerHTML = '';
      instrucciones.forEach(instruccion => {
        const li = document.createElement('li');
        li.textContent = instruccion.descripcion;
        lista.appendChild(li);
      });
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
    }
  }
  
  // Configurar estado de me gusta
  function configurarMeGusta(receta) {
    {% if current_user.is_authenticated %}
      const btnLike = document.getElementById('btnLikeModal');
      const iconoLike = document.getElementById('iconoLikeModal');
      const contadorLike = document.getElementById('contadorLikeModal');
      
      if (btnLike && iconoLike && contadorLike) {
        if (receta.usuario_dio_like) {
          btnLike.classList.add('liked');
          iconoLike.textContent = '‚ô•';
        } else {
          btnLike.classList.remove('liked');
          iconoLike.textContent = '‚ô°';
        }
        contadorLike.textContent = receta.total_me_gustas || 0;
      }
    {% endif %}
  }
  
  // Resetear secciones del modal
  function resetearSeccionesModal() {
    const secciones = [
      'modalTiempoContainer',
      'modalCategoriasContainer', 
      'modalIngredientesContainer',
      'modalInstruccionesContainer'
    ];
    
    secciones.forEach(id => {
      const elemento = document.getElementById(id);
      if (elemento) elemento.style.display = 'none';
    });
  }
  
  // Mostrar error en modal
  function mostrarErrorModal() {
    document.getElementById('modalTitulo').textContent = 'Error al cargar la receta';
    document.getElementById('modalDescripcion').textContent = 'No se pudo cargar la informaci√≥n de la receta. Por favor, intenta nuevamente.';
  }
  
  // Cerrar modal
  function cerrarModalReceta() {
    const modal = document.getElementById('modalDetalleReceta');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    recetaActualId = null;
  }
  
  // Ver receta completa
  function verRecetaCompleta() {
    if (recetaActualId) {
      window.location.href = `/api/recetas/${recetaActualId}`;
    }
  }
  
  /* ==============================================
     FUNCIONES DE ME GUSTA
     ============================================== */
  
  {% if current_user.is_authenticated %}
  // Me gusta en modal
  async function toggleMeGustaModal() {
    if (!recetaActualId) return;
    
    const btnLike = document.getElementById('btnLikeModal');
    const iconoLike = document.getElementById('iconoLikeModal');
    const contadorLike = document.getElementById('contadorLikeModal');
    
    if (!btnLike || !iconoLike || !contadorLike) return;
    
    // Estado de carga
    btnLike.disabled = true;
    const iconoOriginal = iconoLike.textContent;
    iconoLike.innerHTML = '<div class="loading-spinner"></div>';
    
    try {
      const response = await fetch(`/api/recetas/${recetaActualId}/me-gusta`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
        },
        body: new URLSearchParams({
          'csrf_token': '{{ csrf_token() if csrf_token else "" }}'
        })
      });
      
      if (response.ok) {
        const isLiked = btnLike.classList.contains('liked');
        let newCount = parseInt(contadorLike.textContent) || 0;
        
        // Actualizar estado
        if (isLiked) {
          btnLike.classList.remove('liked');
          iconoLike.textContent = '‚ô°';
          newCount = Math.max(0, newCount - 1);
        } else {
          btnLike.classList.add('liked');
          iconoLike.textContent = '‚ô•';
          newCount += 1;
        }
        
        contadorLike.textContent = newCount;
        
        // Sincronizar con tarjeta
        sincronizarMeGustaConTarjeta(recetaActualId, !isLiked, newCount);
        
      } else {
        throw new Error('Error en la respuesta del servidor');
      }
      
    } catch (error) {
      console.error('Error al procesar me gusta:', error);
      iconoLike.textContent = iconoOriginal;
    } finally {
      btnLike.disabled = false;
    }
  }
  
  // Me gusta en tarjetas
  async function toggleMeGusta(recetaId) {
    const btnLike = document.getElementById(`btn-like-${recetaId}`);
    const contadorSpan = document.querySelector(`#me-gustas-${recetaId} .contador-likes`);
    
    if (!btnLike || !contadorSpan) return;
    
    const isLiked = btnLike.classList.contains('liked');
    let currentCount = parseInt(contadorSpan.textContent) || 0;
    
    // Cambio visual inmediato
    const newCount = isLiked ? Math.max(0, currentCount - 1) : currentCount + 1;
    actualizarEstadoMeGusta(btnLike, contadorSpan, !isLiked, newCount);
    
    try {
      const response = await fetch(`/api/recetas/${recetaId}/me-gusta`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
        },
        body: new URLSearchParams({
          'csrf_token': '{{ csrf_token() if csrf_token else "" }}'
        })
      });
      
      if (!response.ok) {
        // Revertir cambios si hay error
        actualizarEstadoMeGusta(btnLike, contadorSpan, isLiked, currentCount);
        throw new Error('Error en la respuesta del servidor');
      }
      
    } catch (error) {
      console.error('Error al procesar me gusta:', error);
      // El estado ya se revirti√≥ arriba
    }
  }
  
  // Actualizar estado visual de me gusta
  function actualizarEstadoMeGusta(btn, contador, liked, count) {
    if (liked) {
      btn.textContent = '‚ô•';
      btn.classList.add('liked');
    } else {
      btn.textContent = '‚ô°';
      btn.classList.remove('liked');
    }
    contador.textContent = count;
  }
  
  // Sincronizar me gusta entre modal y tarjeta
  function sincronizarMeGustaConTarjeta(recetaId, liked, count) {
    const tarjetaBtn = document.getElementById(`btn-like-${recetaId}`);
    const tarjetaContador = document.querySelector(`#me-gustas-${recetaId} .contador-likes`);
    
    if (tarjetaBtn && tarjetaContador) {
      actualizarEstadoMeGusta(tarjetaBtn, tarjetaContador, liked, count);
    }
  }
  
  // Inicializar estados de me gusta al cargar
  async function inicializarEstadosMeGusta() {
    const botonesLike = document.querySelectorAll('[id^="btn-like-"]');
    
    for (const btn of botonesLike) {
      const recetaId = btn.id.replace('btn-like-', '');
      
      try {
        const response = await fetch(`/api/recetas/${recetaId}`, {
          headers: { 'Accept': 'application/json' }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.receta && data.receta.usuario_dio_like) {
            btn.textContent = '‚ô•';
            btn.classList.add('liked');
          }
        }
      } catch (error) {
        console.error(`Error al verificar me gusta para receta ${recetaId}:`, error);
      }
    }
  }
  {% endif %}
  
  /* ==============================================
     CONFIGURACI√ìN DE EVENTOS
     ============================================== */
  
  // Configurar eventos del modal
  function configurarEventosModal() {
    const modal = document.getElementById('modalDetalleReceta');
    
    if (!modal) return;
    
    // Cerrar con click fuera del modal
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        cerrarModalReceta();
      }
    });
    
    // Cerrar con tecla Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        cerrarModalReceta();
      }
    });
    
    // Prevenir propagaci√≥n en elementos internos de tarjetas
    document.querySelectorAll('.tarjeta-receta button, .tarjeta-receta a').forEach(element => {
      element.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    });
  }
  
  // Configurar filtros
  function configurarFiltros() {
    const filtros = document.querySelectorAll('.filtro-btn');
    filtros.forEach(filtro => {
      filtro.addEventListener('click', function() {
        // Remover clase activo de todos
        filtros.forEach(f => f.classList.remove('activo'));
        // Agregar clase activo al clickeado
        this.classList.add('activo');
      });
    });
  }
  
  // Configurar formulario de b√∫squeda
  function configurarBusqueda() {
    const formBusqueda = document.querySelector('.formulario-busqueda');
    const inputBusqueda = document.querySelector('.input-busqueda');
    
    if (formBusqueda && inputBusqueda) {
      // B√∫squeda con Enter
      inputBusqueda.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          buscarRecetas();
        }
      });
      
      // Prevenir env√≠o duplicado del formulario
      formBusqueda.addEventListener('submit', function(e) {
        e.preventDefault();
        buscarRecetas();
      });
    }
  }
  
  /* ==============================================
     FUNCIONES AUXILIARES
     ============================================== */
  
  // Funci√≥n para b√∫squeda de recetas
  function buscarRecetas() {
    const searchInput = document.querySelector('.input-busqueda');
    if (!searchInput) return;
    
    const searchTerm = searchInput.value.trim();
    
    if (searchTerm.length >= 1) {
      window.location.href = `/api/recetas?q=${encodeURIComponent(searchTerm)}`;
    } else if (searchTerm.length === 0) {
      window.location.href = `/`;
    }
  }
  
  // Funci√≥n para manejar errores de red
  function manejarErrorRed(error) {
    console.error('Error de red:', error);
    
    // Mostrar notificaci√≥n al usuario (opcional)
    const mensaje = document.createElement('div');
    mensaje.className = 'notificacion-error';
    mensaje.textContent = 'Error de conexi√≥n. Por favor, intenta nuevamente.';
    mensaje.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      z-index: 9999;
      animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(mensaje);
    
    // Remover despu√©s de 3 segundos
    setTimeout(() => {
      if (mensaje.parentNode) {
        mensaje.parentNode.removeChild(mensaje);
      }
    }, 3000);
  }
  
  // Funci√≥n para debounce (optimizaci√≥n)
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  /* ==============================================
     INICIALIZACI√ìN
     ============================================== */
  
  // Inicializar todo cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando aplicaci√≥n...');
    
    try {
      // Configurar eventos del modal
      configurarEventosModal();
      
      // Configurar filtros
      configurarFiltros();
      
      // Configurar b√∫squeda
      configurarBusqueda();
      
      // Inicializar estados de me gusta si el usuario est√° autenticado
      {% if current_user.is_authenticated %}
      inicializarEstadosMeGusta();
      {% endif %}
      
      console.log('Aplicaci√≥n inicializada correctamente');
      
    } catch (error) {
      console.error('Error durante la inicializaci√≥n:', error);
      manejarErrorRed(error);
    }
  });
  
  // Manejar errores globales
  window.addEventListener('error', function(e) {
    console.error('Error global capturado:', e.error);
    manejarErrorRed(e.error);
  });
  
  // Manejar promesas rechazadas
  window.addEventListener('unhandledrejection', function(e) {
    console.error('Promesa rechazada:', e.reason);
    manejarErrorRed(e.reason);
    e.preventDefault(); // Prevenir que aparezca en la consola
  });
  
</script>
</body>
</html>