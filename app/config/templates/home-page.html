<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recetas Sencillas</title>
  <link rel="stylesheet" href="../../static/css/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Onest:wght@100..900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="encabezado">
    <div class="contenedor">
      <h1 class="logo">Recetas Sencillas</h1>
      <nav class="navegacion">
        <ul>
        </ul>
      </nav>
      <div class="botones-header">
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('api.ver_perfil', usuario_id=current_user.id) }}" class="enlace-usuario">
              <img src="{{ url_for('static', filename=current_user.foto_perfil) if current_user.foto_perfil != 'default.jpg' else 'https://via.placeholder.com/32x32?text=' + current_user.nombre[0] }}" 
                   alt="Foto de perfil" 
                   class="avatarUsuarioSesion">
              <span>{{ current_user.nombre }}</span>
            </a>
          <a href="{{ url_for('api.logout') }}">
            <button class="btn-transparente">Cerrar Sesión</button>
          </a>
        {% else %}
          <a href="{{ url_for('api.login') }}">
            <button class="btn-transparente">Iniciar Sesión</button>
          </a>
          <a href="{{ url_for('api.register') }}">
            <button class="btn-blanco">Registrarse</button>
          </a>
        {% endif %}
      </div>
    </div>
  </header>

  <main class="contenedor principal">
    <h2 class="titulo-seccion">Descubre nuestras recetas</h2>
    
    <!-- Formulario de búsqueda -->
    <div class="busqueda-container">
      <form method="GET" action="{{ url_for('api.listar_recetas') }}" class="formulario-busqueda">
        <input type="text" name="q" placeholder="Buscar recetas..." value="{{ request.args.get('q', '') }}" 
               class="input-busqueda">
        <button type="submit" class="btn-busqueda">
          Buscar
        </button>
      </form>
    </div>
    
    <!-- Filtros por categoría -->
    <div class="filtros">
      <button class="filtro-btn {{ 'activo' if not request.args.get('categoria') else '' }}" 
              onclick="window.location.href='{{ url_for('main.index') }}'">
        Todas
      </button>
      {% if categorias %}
        {% for categoria in categorias %}
          <button class="filtro-btn {{ 'activo' if request.args.get('categoria')|int == categoria.id else '' }}"
                  onclick="window.location.href='{{ url_for('api.listar_recetas', categoria=categoria.id) }}'">
            {{ categoria.nombre }}
          </button>
        {% endfor %}
      {% else %}
        <!-- Filtros de ejemplo -->
        <button class="filtro-btn">Más recientes</button>
        <button class="filtro-btn">Más gustadas</button>
        <button class="filtro-btn">Más rápidas</button>
        <button class="filtro-btn">Sin gluten</button>
      {% endif %}
    </div>

    <!-- Grid de recetas -->
    <section class="grid-recetas">
      {% if recetas_recientes %}
        {% for receta in recetas_recientes %}
          <article class="tarjeta-receta">
            <div class="imagen" 
                 style="background-image: url('{{ receta.imagen_portada if receta.imagen_portada else 'https://via.placeholder.com/300x200?text=Sin+Imagen' }}');">
            </div>
            <div class="contenido">
              <h3>
                <a href="{{ url_for('api.ver_receta', receta_id=receta.id) }}" class="titulo-receta">
                  {{ receta.titulo }}
                </a>
              </h3>
              <p class="descripcion-receta">{{ receta.descripcion[:100] }}{% if receta.descripcion|length > 100 %}...{% endif %}</p>
              
              <div class="footer-tarjeta">
                <span class="tiempo-receta">
                  {% if receta.tiempor_pre %}
                    Hace {{ receta.tiempor_pre }}
                  {% else %}
                    {{ moment(receta.fecha_creacion).fromNow() if moment else receta.fecha_creacion.strftime('%d/%m/%Y') }}
                  {% endif %}
                </span>
                <div class="acciones-receta">
                  {% if current_user.is_authenticated %}
                    <form method="POST" action="{{ url_for('api.dar_me_gusta', receta_id=receta.id) }}" class="form-me-gusta">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                      <button type="submit" class="btn-corazon">
                        {% if receta.usuario_dio_like %}♥{% else %}♡{% endif %}
                      </button>
                    </form>
                  {% else %}
                    <span class="corazon">♡</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </article>
        {% endfor %}
      {% else %}
        <!-- Mensaje cuando no hay recetas -->
        <div class="no-recetas">
          <h3>No hay recetas disponibles</h3>
          <p>¡Sé el primero en compartir una deliciosa receta!</p>
          {% if current_user.is_authenticated %}
            <a href="{{ url_for('api.nueva_receta') }}" class="btn-crear-receta">
              Crear Primera Receta
            </a>
          {% else %}
            <p class="texto-registro">
              <a href="{{ url_for('api.register') }}" class="enlace-registro">Regístrate</a> para crear tu primera receta
            </p>
          {% endif %}
        </div>
      {% endif %}
    </section>
    
    <!-- Paginación -->
    {% if pagination %}
      <div class="paginacion">
        {% if pagination.has_prev %}
          <a href="{{ url_for('api.listar_recetas', pagina=pagination.prev_num) }}" class="btn-paginacion">← Anterior</a>
        {% endif %}
        
        <span class="pagina-actual">Página {{ pagination.page }} de {{ pagination.pages }}</span>
        
        {% if pagination.has_next %}
          <a href="{{ url_for('api.listar_recetas', pagina=pagination.next_num) }}" class="btn-paginacion">Siguiente →</a>
        {% endif %}
      </div>
    {% endif %}
  </main>

  <footer class="pie">
    <p>© 2025 Recetas Sencillas – Todos los derechos reservados</p>
    <p>Contacto: contacto@recetas-sencillas.com</p>
  </footer>

  <!-- JavaScript para funcionalidades dinámicas -->
  <script>
    // Función para manejar el me gusta con AJAX
    function toggleMeGusta(recetaId) {
      fetch(`/api/recetas/${recetaId}/me-gusta`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() }}'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          location.reload();
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }
    
    // Función para búsqueda dinámica
    function buscarRecetas() {
      const searchInput = document.querySelector('input[name="q"]');
      const searchTerm = searchInput.value.trim();
      
      if (searchTerm.length > 2) {
        window.location.href = `/api/recetas?q=${encodeURIComponent(searchTerm)}`;
      }
    }

    // Agregar funcionalidad a los filtros
    document.addEventListener('DOMContentLoaded', function() {
      const filtros = document.querySelectorAll('.filtro-btn');
      filtros.forEach(filtro => {
        filtro.addEventListener('click', function() {
          // Remover clase activo de todos
          filtros.forEach(f => f.classList.remove('activo'));
          // Agregar clase activo al clickeado
          this.classList.add('activo');
        });
      });
    });
  </script>
</body>
</html>